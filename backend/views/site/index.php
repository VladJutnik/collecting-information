<?php/* @var $this yii\web\View */use common\models\Organization;use common\models\User;use yii\bootstrap4\Html;use yii\helpers\ArrayHelper;$this->title = 'Главная';?><style>    .super-block {        display: flex;        justify-content: space-between;    }    .super-block2 {        display: flex;        flex-wrap: wrap;        margin-bottom: 30px;        margin-top: 30px;        justify-content: space-around;    }    .box-shadow {        /*width: 80%;*/        min-width: 375px;        min-height: 180px;        /*margin: 1em auto;*/        padding: 1em;        box-shadow: 0 2px 4px rgba(0, 0, 0, .2);        margin-left: 20px;        margin-bottom: 30px;        background: linear-gradient(to left, #0ea1a8 2%, transparent 2%);        border-radius: 10px;    }    .box-shadow:hover {        box-shadow: 0 4px 8px rgba(0, 0, 0, .2);        cursor: pointer;    }    .title_number {        margin-top: 30px;        font-size: 32px;        color: #0ea1a8 !important;    }</style><? if (Yii::$app->user->can('rospotrebnadzor')) { ?>    <?php    //SELECT	//COUNT(*) AS `total_organizations`,	//(SELECT COUNT(*) FROM `organization` WHERE federal_district_id = 5 and region_id = 48 and organization_type_id = 5 ) AS `food_organizer`,	//(SELECT COUNT(*) FROM `deti_anket` WHERE federal_district_id = 5 and region_id = 48) AS `count_anket_deti`,	//(SELECT COUNT(*) FROM `director` WHERE federal_district_id = 5 and region_id = 48) AS `count_anket_director`,	//(SELECT COUNT(*) FROM `food` WHERE federal_district_id = 5 and region_id = 48) AS `count_anket_food`    //FROM	//`organization`    //WHERE organization.federal_district_id = 5 and organization.region_id = 48 and organization.organization_type_id = 5    $querys = (new \yii\db\Query())    ->select(        [            'COUNT(*) AS `total_organizations`',            '(SELECT COUNT(*) FROM `organization` WHERE federal_district_id = '.Yii::$app->user->identity->federal_district_id.' and region_id = '.Yii::$app->user->identity->region_id.' and organization_type_id = 3 and id <> 3) AS `food_organizer`',            '(SELECT COUNT(*) FROM `deti_anket` WHERE federal_district_id = '.Yii::$app->user->identity->federal_district_id.' and region_id = '.Yii::$app->user->identity->region_id.') AS `count_anket_deti`',            '(SELECT COUNT(*) FROM `director` WHERE federal_district_id = '.Yii::$app->user->identity->federal_district_id.' and region_id = '.Yii::$app->user->identity->region_id.') AS `count_anket_director`',            '(SELECT COUNT(*) FROM `food` WHERE federal_district_id = '.Yii::$app->user->identity->federal_district_id.' and region_id = '.Yii::$app->user->identity->region_id.') AS `count_anket_food` ',        ]    )    ->from('organization')    ->where(['organization_type_id' => 5,        'federal_district_id'=>Yii::$app->user->identity->federal_district_id,        'region_id'=>Yii::$app->user->identity->region_id    ])->andWhere(['not in', 'id', [1,3,4,5,6,7,10,11]])    ->one();    ?>    <p class="text-center" style="font-size: 20px;"><b>Информация: <?= Yii::$app->myComponent->get_region_name(Organization::find()->select('region_id')->where(['id'=>Yii::$app->user->identity->organization_id])->one()->region_id);            ?>:</b></p>    <div class="super-block2">        <div class="box-shadow">            <p class="text-center"><b>Всего общеобразовательных организаций <br>в регионе:</b></p>            <p class="text-center title_number"><b><?= $querys['total_organizations'] ?></b></p>        </div>        <div class="box-shadow">            <p class="text-center"><b>Зарегистрировалось операторов питания:</b></p>            <p class="text-center title_number"><b><?= $querys['food_organizer'] ?></b></p>        </div>    </div>    <div class="super-block2">        <div class="box-shadow">            <p class="text-center"><b>Количество внесенных анкет №1<br>руководителей общеобразовательных организаций:</b></p>            <p class="text-center title_number"><b><?= $querys['count_anket_director'] ?></b></p>        </div>        <div class="box-shadow">            <p class="text-center"><b>Количество внесенных анкет №2<br>операторов питания:</b></p>            <p class="text-center title_number"><b><?= $querys['count_anket_food'] ?></b></p>        </div>        <div class="box-shadow">            <p class="text-center"><b>Количество внесенных анкет №3<br>детей и родителей обучающихся:</b></p>            <p class="text-center title_number"><b><?= $querys['count_anket_deti'] ?></b></p>        </div>    </div><? } ?><? if (Yii::$app->user->can('director_school')) { ?>    <?php    /*select    count(*) as  `count_total`,    count( case when field1_3 = 1 then 1 else NULL end) as  `9_10_age`,    count( case when field1_3 = 2 then 1 else NULL end) as  `13_14_age`,    count( case when field1_3 = 3 then 1 else NULL end) as  `15_17_age`    from deti_anket    WHERE organization_id = 4*/    $querys = (new \yii\db\Query())        ->select(            [                'COUNT(*) AS `count_total`',                'count( case when field1_1 = 2 then 1 else NULL end) as `9_10_age`',                'count( case when field1_1 = 5 then 1 else NULL end) as `13_14_age`',                'count( case when field1_1 = 10 then 1 else NULL end) as `15_17_age`',            ]        )        ->from('deti_anket')        ->where([            'organization_id'=> Yii::$app->user->identity->organization_id,        ])        ->one();    ?>   <!-- <p class="text-center" style="font-size: 20px;"><b>Информация по МБОУ Гимназия №1:</b></p>-->    <div class="super-block2">        <div class="box-shadow">            <p class="text-center"><b>Количество внесенных анкет №3<br>детей и родителей обучающихся:</b></p>            <p class="text-center title_number"><b><?=$querys['count_total']?></b></p>        </div>    </div>    <div class="super-block2">        <div class="box-shadow">            <p class="text-center"><b>Количество внесенных анкет <br> 2 класс:</b></p>            <p class="text-center title_number"><b><?=$querys['9_10_age']?></b></p>        </div>        <div class="box-shadow">            <p class="text-center"><b>Количество внесенных анкет <br> 5 класс:</b></p>            <p class="text-center title_number"><b><?=$querys['13_14_age']?></b></p>        </div>        <div class="box-shadow">            <p class="text-center"><b>Количество внесенных анкет <br> 10 класс:</b></p>            <p class="text-center title_number"><b><?=$querys['15_17_age']?></b></p>        </div>    </div><? } ?><? if (Yii::$app->user->can('food_organizer')) { ?>    <p class="text-center" style="font-size: 20px;"><b>Информация об организаторе (операторе) питания:</b></p>    <div class="super-block2">        <div class="box-shadow">            <?php $count_food_organizer = \common\models\FoodOrganizer::find()->where(['user_id'=>Yii::$app->user->identity->id])->count();?>            <p class="text-center"><b>Количество прикрепленных организаций:</b></p>            <p class="text-center title_number"><b><?=$count_food_organizer ?></b></p>        </div>    </div><? } ?><? if (Yii::$app->user->can('curator')) {    $strArrya = explode('/', Yii::$app->user->identity->work_position);    /*   SELECT       sum( case when `organization_type_id` = 5 then 1 else NULL end) as  `schoolCount`,       sum( case when `organization_type_id` = 3 then 1 else NULL end) as  `foodCount`,       (SELECT COUNT(*) from `director` WHERE `director`.`organization_id` = `organization`.`id`) as  `directorCountResult`,       (SELECT COUNT(*) from `food` WHERE `food`.`organization_id` = `organization`.`id`) as  `foodCountResult`   FROM `organization`   where `federal_district_id` = 5   */    if($strArrya){        foreach ($strArrya as $district){            $querys = (new \yii\db\Query())                ->select(                    [                        'sum( case when `organization_type_id` = 5 then 1 else 0 end) as  `schoolCount`',                        'sum( case when `organization_type_id` = 3 then 1 else 0 end) as  `foodCount`',                        '(SELECT COUNT(*) from `director` WHERE `director`.`federal_district_id` = `organization`.`federal_district_id`) as  `directorCountResult`',                        '(SELECT COUNT(*) from `food` WHERE `food`.`federal_district_id` = `organization`.`federal_district_id`) as  `foodCountResult`',                        '(SELECT COUNT(*) from `deti_anket` WHERE `deti_anket`.`federal_district_id` = `organization`.`federal_district_id`) as  `detiCountResult`',                    ]                )                ->from('organization')                ->where([                            'federal_district_id'=> $district,                        ])                ->one();            ?>            <p class="text-center" style="font-size: 20px;"><b>Информация по <?= Yii::$app->myComponent->get_federal_name($district) ?>: </b></p>            <div class="super-block2">                <div class="box-shadow">                    <p class="text-center"><b>Количество общеобразовательных организаций:</b></p>                    <p class="text-center title_number"><b><?=$querys['schoolCount'] ?></b></p>                </div>                <div class="box-shadow">                    <p class="text-center"><b>Количество зарегистрировавшихся организаторов питания:</b></p>                    <p class="text-center title_number"><b><?=$querys['foodCount'] ?></b></p>                </div>                <div class="box-shadow">                    <p class="text-center"><b>Количество внесенных анкет директоров всего:</b></p>                    <p class="text-center title_number"><b><?=$querys['directorCountResult'] ?></b></p>                </div>                <div class="box-shadow">                    <p class="text-center"><b>Количество внесенных анкет организаторов питания всего:</b></p>                    <p class="text-center title_number"><b><?=$querys['foodCountResult'] ?></b></p>                </div>                <div class="box-shadow">                    <p class="text-center"><b>Количество внесенных анкет школьников всего:</b></p>                    <p class="text-center title_number"><b><?=$querys['detiCountResult'] ?></b></p>                </div>            </div>        <?        }    }    ?><? } ?>